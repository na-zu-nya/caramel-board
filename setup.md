setup.sh 要件定義（Draft）
=================================

本書は CaramelBoard の初期セットアップスクリプト `setup.sh` の要件を定義します。まず仕様を固定し、その後の実装/修正は本書に追随させます。

目的 / スコープ
---------------------------------
- 目的: 初回導入および再実行時の環境整備を、非エンジニアにも分かりやすく対話式で行う。
- スコープ: 依存チェック、言語選択、依存インストール、開発用DB起動、Prisma生成、（任意）JoyTagの導入、（任意）docker-compose.local.yml 生成。
- 非スコープ: 本番起動やマイグレーション適用は `serve.sh` の責務（`serve.sh update|migrate`）。

実行環境要件（前提）
---------------------------------
- OS: Windows（WSL2 上の Ubuntu）、macOS、Linux（Debian/Ubuntu系想定）。
- 必須コマンド（ユーザー）:
  - `docker` と `docker compose`（またはレガシー `docker-compose`）のみ。
  - Node.js / npm は不要（開発者モードのみ任意。開発者モードはsetup.sh devで起動し、それ以外の場合はユーザPCの本番環境想定）。
- ネットワーク: npm パッケージの取得、必要に応じて GitHub / HuggingFace へのアクセス（JoyTag 有効時）。
- 権限: 追加の昇格（sudo 等）は原則不要。必要な場合は明示の確認を出す。

対話仕様（UI）
---------------------------------
- すべての問いは「番号選択 + 既定値」の形式で提示する。
  - 例: `Select language:` → `1) English  2) 日本語` → `[default:1]:`
- y/N 表記は使用しない。非エンジニアでも直感的に分かることを優先。
- TTY が無い場合（非対話環境）は既定値で進め、最後に選択内容のサマリを表示。
- プロンプトの文言は英語を既定とし、日本語へ切替可能（マルチリンガル）。

言語 / 表示
---------------------------------
- 初回起動時に言語を選択:
  - English（既定）/ 日本語。
  - `.env` に `CB_LANG=en|ja` を保存。
- 以後の `setup.sh` および `serve.sh` のメッセージは `CB_LANG` に従う。

JoyTag（自動タグ付け）方針（オプトイン）
---------------------------------
- 既定で無効。
- 有効化確認の際に、以下の注意を表示（簡潔・明確・改行中心）：
  - JoyTag はローカルで動作し、画像のタグ確率を計算する推論ライブラリ。
  - 本機能はローカルでタグを推定する用途のみに使用。新規生成・学習・外部送信は行わない。
  - モデル/重みは外部配布物であり、利用者が規約を確認のうえ自己責任で利用する。
  - 規約URLは `.env` の `JOYTAG_INFO_URL` を表示（未設定時は既定URL）。
- ユーザーが「有効化」を選んだ場合のみ、以下を実施：
  - python3が利用できるか確認
  - `externals/joytag` を作成し、リポジトリを取得（git または ZIP）。
  - `integrations/joytag/*` をコピー（ブリッジ配置）。
  - `python3 -m venv` による仮想環境と依存導入（要 `requirements-server.txt`）。
  - モデル入手方法の選択：`huggingface-cli` / `git lfs` / 既存パス指定 / スキップ。
  - `.env` に `CB_ENABLE_JOYTAG=true` を保存（無効なら false）。

依存インストール / 生成 / 起動（Docker 実行前提）
---------------------------------
- すべてコンテナ内で実行する。ホスト側での `npm ci` や Node.js は不要。
- 初期化の標準シーケンス（setup から内部呼び出し想定）:
  1) `docker compose build app`（初回のみ）
  2) `docker compose run --rm app npm run db:migrate:prod`（Prisma Migrate deploy）
  3) `docker compose up -d app`
- 開発用DBを使うときのみ `docker-compose.dev.yml` を併用（開発者向け）。

ローカルオーバーライド生成（任意）
---------------------------------
- `docker-compose.local.yml` を生成するか確認（番号選択）。
- 収集する入力：
  - assets ディレクトリ（ホスト）パス（既定: `./data/assets`）。
  - Postgres データ（ホスト）パス（既定: `./data/postgres`）。
- 指定ディレクトリが未作成なら作成可否を確認（番号選択）。
- 生成ファイルは Git 管理外（.gitignore 済み）。

永続化 / 作成・変更するファイル
---------------------------------
- `.env`（新規または更新）
  - `CB_LANG`（en|ja）
  - `CB_ENABLE_JOYTAG`（true|false）
  - `JOYTAG_INFO_URL`（既定URLから変更可）
- `docker-compose.local.yml`（任意生成）
- `externals/joytag` 以下（JoyTag 有効化時のみ）
- `data/.gitkeep`（リポジトリにディレクトリを保持するため）

冪等性 / 再実行
---------------------------------
- `setup.sh` は何度でも再実行可能であること：
  - 既に存在するディレクトリ/ファイルは再利用し、破壊的操作を行わない。
  - JoyTag リポジトリは存在すれば流用。モデルも既存があれば取得を省略。
  - venv があれば再作成しない。依存は必要に応じて再インストール可。
  - npm 依存や Prisma 生成は再実行可能なコマンドのみ使用。
- `.env` の既存値は尊重し、再実行時は既定値より `.env` を優先。

エラー処理 / 終了コード
---------------------------------
- 必須コマンド不足時は即時エラーメッセージを出して `exit 1`。
- 外部取得（git/ZIP/huggingface）失敗時は、そのステップをスキップし、復旧方法を案内。
- 途中での非致命エラーは極力継続し、最後にサマリで注意喚起。

非対話モード（CI 等）
---------------------------------
- TTY でない場合、すべて既定値で実行：
  - 言語: English（`CB_LANG` 未設定時）
  - JoyTag: 無効（`CB_ENABLE_JOYTAG=false`）
  - local.yml 生成: スキップ
- 実行後、選択/スキップ内容のサマリを出力。
- 事前に `.env` へ `CB_LANG`、`CB_ENABLE_JOYTAG`、`JOYTAG_INFO_URL` を設定すれば非対話で希望どおりに動作。

Windows / WSL
---------------------------------
- Windows では `setup.bat` が WSL 経由で `./setup.sh` を起動。
- 事前に `wsl --install` と Docker Desktop（WSL 統合）を済ませる。

ログ / 出力スタイル
---------------------------------
- ステップ開始時に簡潔な見出しを表示（例: `[setup] Generating Prisma client…`）。
- プロンプトは読みやすく改行を活用し、番号付きリスト + `[default:n]` を必ず表示。
- サマリ（完了時）に主な選択結果と次の操作（`./serve.sh`）を案内。

セキュリティ / ライセンス注意
---------------------------------
- JoyTag のモデル/重みに関して、第三者配布物である点を明示。
- 規約URL（`JOYTAG_INFO_URL`）を表示し、自己責任での利用を明記。
- ネットワークアクセスが発生するステップは明示表示（git/ZIP/huggingface 等）。

ハッピーパス（参考）
---------------------------------
1. `./setup.sh` 実行
2. 言語: 1) English
3. 依存チェック OK（Docker のみ）
4. local.yml 生成: 1) Yes → assets=`./data/assets`, postgres=`./data/postgres` を既定に編集可
5. 初期化: build → migrate(deploy) → up -d
6. JoyTag: 2) 無効のまま（必要なら有効化を選択）
7. サマリ表示 → `./serve.sh` で起動

受け入れ基準（Acceptance Criteria）
---------------------------------
- 数値選択プロンプトが確実に表示され、既定値で Enter だけでも完走できる。
- 必須依存が揃っていれば、どの OS でも成功率が高い（Windows は WSL 前提）。
- JoyTag は明示的に有効化した場合のみ導入される。注意文と規約URLが必ず表示される。
- 再実行しても壊れない（冪等）。
- 非対話（CI）でも `.env` のみで制御でき、プロンプト待ちにならない。
